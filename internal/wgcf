#!/bin/bash

update_wgcf_config() {
  local IFACE=$(ip route show default | awk '{print $5}')
  local IPv4=$(ip addr show dev "$IFACE" | awk '/inet /{print $2}' | cut -d' ' -f2)
  local IPv6=$(ip addr show dev "$IFACE" | awk '/inet6 /{print $2}' | cut -d' ' -f2)

  local TEMP_DIR="$(mktemp -d)"
  local DIST_DIR="$(dirname "$1")"

  pushd "$TEMP_DIR" &> /dev/null || exit 1
  if [ -f "$DIST_DIR/wgcf-account.toml" ]; then
    cp "$DIST_DIR/wgcf-account.toml" "$TEMP_DIR/wgcf-account.toml"
  else
    wgcf register --accept-tos
  fi

  # Update License
  if [ -n "$WGCF_LICENSE_KEY" ]; then
    sed -i -e "s/license_key =.*/license_key = '$WGCF_LICENSE_KEY'/g" wgcf-account.toml
  fi

  wgcf update
  wgcf generate
  mkdir -p "$DIST_DIR" &> /dev/null
  cp wgcf-account.toml "$DIST_DIR/wgcf-account.toml"

  sed -i "/\[Interface\]/a PostDown = ip -6 rule delete from ${IPv6}  lookup main" wgcf-profile.conf
  sed -i "/\[Interface\]/a PostUp = ip -6 rule add from ${IPv6} lookup main" wgcf-profile.conf
  sed -i "/\[Interface\]/a PostDown = ip -4 rule delete from ${IPv4} lookup main" wgcf-profile.conf
  sed -i "/\[Interface\]/a PostUp = ip -4 rule add from ${IPv4} lookup main" wgcf-profile.conf

  # Update MTU
  if [ -n "$MTU" ]; then
    sed -i -e "s/MTU =.*/MTU = $MTU/g" wgcf-profile.conf
  fi

  # Update DNS
  if [ -n "$DNS" ]; then
    sed -i -e "s/DNS =.*/DNS = $DNS/g" wgcf-profile.conf
  fi

  cp wgcf-profile.conf "$DIST_DIR/wgcf-profile.conf"
  popd &> /dev/null || exit 1
  rm -fr "$TEMP_DIR"
}

install_wgcf() {
  case "$(arch)" in
    x86_64 | amd64) _ARCH="amd64" ;;
    aarch64 | arm64) _ARCH="arm64" ;;
    armv7l | armv7) _ARCH="armv7" ;;
    mips64le) _ARCH="mips64le_softfloat" ;;
    386 | s390x)
      _ARCH="$TARGETARCH"
      ;;
    *)
      echo "Unsupported architecture. $(arch)"
      exit 1
      ;;
  esac
  local DOWNLOAD_URL="https://github.com/ViRb3/wgcf/releases/download/v${WGCF_VERSION}/wgcf_${WGCF_VERSION}_linux_${_ARCH}"
  wget -qO /usr/local/bin/wgcf "$DOWNLOAD_URL"
  chmod +x /usr/local/bin/wgcf
}
